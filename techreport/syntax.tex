Here we describe the syntax of our extension.
This one is conflictless with the actual syntax used in OCaml 4.04. In the
following section :

\begin{itemize}
\item Programs with a yellow background stand for the original code, while
  blue ones represent generated code.
\item Data constructors indiced with a small cross (such as |XStream|) are
  inaccessible for the programmer.
\item Infix symbol (|▹|) corresponds to the reverse-application operator such that
  (x |▹| f) is equivalent to |f (x)|.
\item Type constructors |codata| and |query| are abstracts and automatically
  imported from module \tt{Pervasives}.
\end{itemize}

\subsection{Codata types}

Codata types are introduced with the |type| keyword.

\sourcecode
\begin{code}
  type α nstream = {
    Head  :  α;
    Tail  :  α nstream;
  }
\end{code}

\gencode
\begin{code}
type (σ,α) stream =
  | XStream  : { dispatch : σ. (σ query,α) stream -> σ } -> (codata,α) stream
  | Head     : (α query,α) stream
  | Tail     : (((codata,α) stream) query,α) stream

let head  = function XStream {dispatch} -> dispatch Head
let tail  = function XStream {dispatch} -> dispatch Tail
\end{code}

\sourcecode
\begin{code}
  type (α,β) nproduct = {
    Fst  :  α;
    Snd  :  β;
  }
\end{code}

\gencode
\begin{code}
type (σ,α,β) product =
  | XProduct  : {dispatch : σ.(σ query,α,β) product -> σ} -> (codata,α,β) product
  | Fst       : (α query,α,β) product
  | Snd       : (β query,α,β) product

let fst  = function XProduct {dispatch} -> dispatch Fst
let snd  = function XProduct {dispatch} -> dispatch Snd
\end{code}


\subsection{Copattern matching}

\sourcecode
\begin{code}
let zeros = comatch zs : int nstream with
  | zs#Head  → 0
  | zs#Tail  → zs
\end{code}

\gencode
\begin{code}
let zeros =
  let rec zs : (codata,int) stream =
    let dispatch : type σ . (σ query,int) stream -> σ = fn
        | Head  → 0
        | Tail  → zs
    in Stream {dispatch}
  in zs
\end{code}

\subsection{Unnesting copatterns}

Here, we process more or less as in \cite{setzer2014unnesting}.

\sourcecode
\begin{code}
let fibonacci = comatch fib : int nstream with
  | fib#Head  → 0
  | fib#Tail#Head  → 1
  | fib#Tail#Tail  → zipWith ( + ) fib fib#Tail
\end{code}

\gencode
\begin{code}
let fibonacci =
  let rec fib : (codata,int) stream =
    let f1 =
      let dispatch : type σ. (σ query, int) stream -> σ = function
        | Head -> 1
        | Tail -> zipWith ( + ) fib (fib ▹ tail)
      in XStream {dispatch}
    in
    let dispatch : type σ. (σ query,int) stream -> σ = function
     | Head -> 0
     | Tail -> f1
    in XStream {dispatch}
  in fib
\end{code}


\subsection{BNF}
